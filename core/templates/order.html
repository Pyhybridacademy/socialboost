{% extends 'base.html' %}
{% block title %}Place Order - {{ service.name }} - SocialBoost{% endblock %}
{% block content %}
<!-- Order Header -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="fw-bold mb-3">Place Your Order</h1>
                <p class="lead">Complete the form below to place your order for {{ service.name }}</p>
            </div>
        </div>
    </div>
</section>

<!-- Order Form -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Order Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5>{{ service.name }}</h5>
                                <span class="badge bg-primary">{{ service.category }}</span>
                            </div>
                            <p>{{ service.description|default:"No description available" }}</p>
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <div class="border rounded p-3 text-center">
                                        <small class="text-muted d-block">Price per 1000</small>
                                        <span class="fw-bold text-primary">₦{{ service.rate|floatformat:2 }}</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="border rounded p-3 text-center">
                                        <small class="text-muted d-block">Min Quantity</small>
                                        <span class="fw-bold">{{ service.min_quantity }}</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="border rounded p-3 text-center">
                                        <small class="text-muted d-block">Max Quantity</small>
                                        <span class="fw-bold">{{ service.max_quantity }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {% if messages %}
                        <div class="mb-3">
                            {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}">
                                {{ message }}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <form method="post" action="{% url 'create_order' %}" id="orderForm" novalidate>
                            {% csrf_token %}
                            <input type="hidden" name="service" value="{{ service.id }}">
                            
                            <div class="mb-3">
                                <label for="link" class="form-label">Link/URL <span class="text-danger">*</span></label>
                                <input type="url" class="form-control" id="link" name="link" placeholder="https://..." required>
                                <div class="form-text">Enter the full URL of your profile, post, or video</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="quantity" name="quantity" 
                                       min="{{ service.min_quantity }}" max="{{ service.max_quantity }}" 
                                       value="{{ service.min_quantity }}" required>
                                <div class="form-text">Min: {{ service.min_quantity }} - Max: {{ service.max_quantity }}</div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="comments" class="form-label">Additional Comments</label>
                                <textarea class="form-control" id="comments" name="comments" rows="3" 
                                          placeholder="Any specific instructions or requirements..."></textarea>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h6 class="card-title">Order Summary</h6>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Service:</span>
                                        <span>{{ service.name }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Quantity:</span>
                                        <span id="summaryQuantity">{{ service.min_quantity }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Price per 1000:</span>
                                        <span>₦{{ service.rate|floatformat:2 }}</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between fw-bold">
                                        <span>Total Price:</span>
                                        <span id="totalPrice">₦{{ initial_price|floatformat:2 }}</span>
                                    </div>
                                    <div class="mt-3">
                                        <div class="alert {% if user_balance.balance >= initial_price %}alert-info{% else %}alert-warning{% endif %}">
                                            <i class="fas fa-info-circle me-2"></i> Your current balance: <strong>₦{{ user_balance.balance|floatformat:2 }}</strong>
                                            {% if user_balance.balance < initial_price %}
                                            <div class="mt-2">
                                                <a href="{% url 'add_funds' %}" class="btn btn-sm btn-warning">Add Funds</a>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" 
                                        {% if user_balance.balance < initial_price %}disabled{% endif %}>
                                    Place Order
                                </button>
                                <a href="{% url 'services' %}" class="btn btn-outline-secondary">Cancel</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const quantityInput = document.getElementById('quantity');
        const summaryQuantity = document.getElementById('summaryQuantity');
        const totalPriceElement = document.getElementById('totalPrice');
        // Convert to string first to ensure proper Decimal handling
        const serviceRate = parseFloat('{{ service.rate }}');
        const userBalance = parseFloat('{{ user_balance.balance }}');
        const submitButton = document.querySelector('button[type="submit"]');
        
        function calculatePrice() {
            const quantity = parseInt(quantityInput.value) || {{ service.min_quantity }};
            const price = (quantity / 1000) * serviceRate;
            
            // Update UI elements
            summaryQuantity.textContent = quantity.toLocaleString();
            totalPriceElement.textContent = '₦' + price.toFixed(2);
            
            // Enable/disable submit button based on user balance
            if (userBalance < price) {
                submitButton.disabled = true;
                submitButton.textContent = 'Insufficient Balance';
            } else {
                submitButton.disabled = false;
                submitButton.textContent = 'Place Order';
            }
        }
        
        // Calculate price on input change
        quantityInput.addEventListener('input', calculatePrice);
        
        // Form validation
        const orderForm = document.getElementById('orderForm');
        orderForm.addEventListener('submit', function(event) {
            const quantity = parseInt(quantityInput.value) || 0;
            const minQuantity = {{ service.min_quantity }};
            const maxQuantity = {{ service.max_quantity }};
            
            // Validate quantity
            if (isNaN(quantity) || quantity < minQuantity || quantity > maxQuantity) {
                event.preventDefault();
                alert(`Quantity must be between ${minQuantity} and ${maxQuantity}`);
                return false;
            }
            
            // Validate link
            const link = document.getElementById('link').value;
            if (!link || !link.trim()) {
                event.preventDefault();
                alert('Please enter a valid link');
                return false;
            }
            
            // Check balance one more time
            const price = (quantity / 1000) * serviceRate;
            if (userBalance < price) {
                event.preventDefault();
                alert('Insufficient balance. Please add funds to your account.');
                return false;
            }
            
            return true;
        });
        
        // Initialize price calculation
        calculatePrice();
    });
</script>
{% endblock %}

